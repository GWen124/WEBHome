name: Deploy to Web Branch

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: package.json

      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            dist
          key: ${{ runner.os }}-vite-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-vite-

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          # éªŒè¯æ„å»ºè¾“å‡º
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found in dist"
            exit 1
          fi
          echo "âœ… Build verification passed"
          ls -la dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 1

      - name: Checkout Web branch
        uses: actions/checkout@v4
        with:
          ref: Web
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean web branch (preserve CNAME)
        run: |
          # å¤‡ä»½CNAMEæ–‡ä»¶
          if [ -f CNAME ]; then
            cp CNAME /tmp/CNAME.backup
          fi
          # æ¸…ç©ºç›®å½•ä½†ä¿ç•™.gitå’ŒCNAME
          find . -maxdepth 1 -not -name '.git' -not -name '.' -not -name 'CNAME' -exec rm -rf {} \;
          # æ¢å¤CNAMEæ–‡ä»¶
          if [ -f /tmp/CNAME.backup ]; then
            mv /tmp/CNAME.backup CNAME
          fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: ./

      - name: Process build files
        run: |
          # æ·»åŠ ç”Ÿæˆæ—¶é—´æ³¨é‡Šåˆ°index.html
          echo "<!-- Generated on $(date) -->" > index.html.tmp
          cat index.html >> index.html.tmp
          mv index.html.tmp index.html
          echo "âœ… Build files processed successfully"
          ls -la

      - name: Commit and push to Web branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            git commit -m "Deploy: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "âœ… Changes committed"
          fi
          git push origin Web
          echo "âœ… Changes pushed to Web branch"

      - name: Get Current Time
        id: time
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Release Archive
        run: |
          # åˆ›å»ºå‘å¸ƒå‹ç¼©åŒ…
          zip -r static-website-v${{ github.run_number }}.zip .
          echo "âœ… Release archive created"
          ls -la static-website-v${{ github.run_number }}.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: WebHome v${{ github.run_number }}
          body: |
            ## WebHome
            
            **å‘å¸ƒæ—¶é—´**: ${{ steps.time.outputs.time }}
            **æ„å»ºç‰ˆæœ¬**: v${{ github.run_number }}
            **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            
            ### ğŸ“¦ å‘å¸ƒå†…å®¹
            - âœ… å®Œæ•´çš„é™æ€ç½‘ç«™æ–‡ä»¶
            - âœ… ä¼˜åŒ–çš„ Vue.js åº”ç”¨
            - âœ… å“åº”å¼è®¾è®¡æ”¯æŒ
            - âœ… ç§»åŠ¨ç«¯é€‚é…
            - âœ… æ·±è‰²æ¨¡å¼æ”¯æŒ
            - âœ… è§¦æ‘¸äº¤äº’ä¼˜åŒ–
            
            ### ğŸ¯ åŠŸèƒ½ç‰¹æ€§
            - **å¤´éƒ¨å¯¼èˆª**: å¯é…ç½®çš„ Logo å’Œå“ç‰Œæ ‡è¯†
            - **ä¸»é¢˜åˆ‡æ¢**: æ”¯æŒæ—¥é—´/å¤œé—´/è·Ÿéšç³»ç»Ÿæ¨¡å¼
            - **é¦–é¡µä»‹ç»**: è‡ªå®šä¹‰æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
            - **é“¾æ¥æ¨¡å—**: å¡ç‰‡å¼å¸ƒå±€ï¼Œæ”¯æŒåˆ†é¡µå’Œæ‹–æ‹½
            - **é¡µè„šä¿¡æ¯**: ç‰ˆæƒä¿¡æ¯å’Œç¤¾äº¤é“¾æ¥
            - **å›¾æ ‡ç³»ç»Ÿ**: åŸºäº @vicons/fa çš„å›¾æ ‡åº“
            
            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - Vue 3 + TypeScript
            - Vite æ„å»ºå·¥å…·
            - å“åº”å¼ CSS Grid å¸ƒå±€
            - è§¦æ§å’Œé¼ æ ‡äº¤äº’æ”¯æŒ
            - ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ–
            
            ### ğŸ“± è®¾å¤‡æ”¯æŒ
            - ğŸ“± æ‰‹æœºç«¯ (â‰¤480px): 1åˆ—å¸ƒå±€
            - ğŸ“± å¹³æ¿ç«¯ (â‰¤768px): 2åˆ—å¸ƒå±€  
            - ğŸ–¥ï¸ æ¡Œé¢ç«¯ (>768px): 4åˆ—å¸ƒå±€
          files: static-website-v${{ github.run_number }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check workflow runs before cleanup
        uses: actions/github-script@v7
        with:
          script: |
            console.log('æ£€æŸ¥å½“å‰å·¥ä½œæµè¿è¡ŒçŠ¶æ€...');
            
            try {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'pages.yml',
                per_page: 20
              });
              
              console.log(`å½“å‰å·¥ä½œæµå…±æœ‰ ${runs.workflow_runs.length} ä¸ªè¿è¡Œè®°å½•`);
              
              const completedRuns = runs.workflow_runs.filter(run => run.status === 'completed');
              console.log(`å…¶ä¸­å·²å®Œæˆçš„æœ‰ ${completedRuns.length} ä¸ª`);
              
              completedRuns.slice(0, 10).forEach((run, index) => {
                console.log(`${index + 1}. è¿è¡Œ #${run.run_number} - çŠ¶æ€: ${run.status} - åˆ›å»ºæ—¶é—´: ${run.created_at}`);
              });
            } catch (error) {
              console.log('âŒ è·å–å·¥ä½œæµè¿è¡Œè®°å½•å¤±è´¥:', error.message);
              console.log('è·³è¿‡æ¸…ç†æ­¥éª¤');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old workflow runs
        uses: actions/github-script@v7
        with:
          script: |
            console.log('å¼€å§‹æ¸…ç†æ—§çš„å·¥ä½œæµè¿è¡Œ...');
            
            try {
              // è·å–å½“å‰å·¥ä½œæµçš„æ‰€æœ‰è¿è¡Œè®°å½•
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'pages.yml',
                per_page: 100,
                status: 'completed'
              });
              
              console.log(`æ‰¾åˆ° ${runs.workflow_runs.length} ä¸ªå·²å®Œæˆçš„å·¥ä½œæµè¿è¡Œ`);
              
              if (runs.workflow_runs.length <= 5) {
                console.log('å·¥ä½œæµè¿è¡Œæ•°é‡ä¸è¶…è¿‡5ä¸ªï¼Œæ— éœ€æ¸…ç†');
                return;
              }
              
              // æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œä¿ç•™æœ€æ–°çš„5ä¸ª
              const sortedRuns = runs.workflow_runs
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              const runsToDelete = sortedRuns.slice(5);
              
              console.log(`å°†åˆ é™¤ ${runsToDelete.length} ä¸ªæ—§çš„å·¥ä½œæµè¿è¡Œ`);
              
              // æ˜¾ç¤ºå°†è¦åˆ é™¤çš„è¿è¡Œä¿¡æ¯
              runsToDelete.forEach((run, index) => {
                console.log(`${index + 1}. è¿è¡Œ #${run.run_number} (${run.id}) - åˆ›å»ºæ—¶é—´: ${run.created_at}`);
              });
              
              let deletedCount = 0;
              let errorCount = 0;
              
              for (const run of runsToDelete) {
                try {
                  await github.rest.actions.deleteWorkflowRun({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    run_id: run.id
                  });
                  console.log(`âœ… å·²åˆ é™¤å·¥ä½œæµè¿è¡Œ #${run.run_number} (${run.id})`);
                  deletedCount++;
                  
                  // æ·»åŠ å°å»¶è¿Ÿé¿å…APIé™åˆ¶
                  await new Promise(resolve => setTimeout(resolve, 200));
                } catch (error) {
                  console.log(`âŒ åˆ é™¤å·¥ä½œæµè¿è¡Œ #${run.run_number} å¤±è´¥: ${error.message}`);
                  console.log(`é”™è¯¯è¯¦æƒ…: ${JSON.stringify(error, null, 2)}`);
                  errorCount++;
                }
              }
              
              console.log(`âœ… æ¸…ç†å®Œæˆ: æˆåŠŸåˆ é™¤ ${deletedCount} ä¸ªï¼Œå¤±è´¥ ${errorCount} ä¸ª`);
              console.log(`ä¿ç•™äº†æœ€æ–°çš„ 5 ä¸ªå·¥ä½œæµè¿è¡Œ`);
            } catch (error) {
              console.log('âŒ æ¸…ç†å·¥ä½œæµè¿è¡Œå¤±è´¥:', error.message);
              console.log('è¿™å¯èƒ½æ˜¯ç”±äºæƒé™ä¸è¶³æˆ–APIé™åˆ¶å¯¼è‡´çš„');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}