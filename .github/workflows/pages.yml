name: ğŸš€ Deploy WebHome

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'vite.config.ts'
      - 'tsconfig.json'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'
  BUILD_DIR: 'dist'
  WEB_BRANCH: 'Web'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check || echo "Type check not configured"

      - name: Lint check
        run: npm run lint || echo "Lint not configured"

  # æ„å»ºå’Œéƒ¨ç½²
  build-and-deploy:
    name: ğŸ—ï¸ æ„å»ºå’Œéƒ¨ç½²
    runs-on: ubuntu-latest
    needs: quality-check
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production

      - name: Build info
        id: build_info
        run: |
          echo "build_time=$(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "build_hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_number=${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-files
          path: dist/
          retention-days: 1

      - name: Checkout web branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.WEB_BRANCH }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Create web branch if not exists
        run: |
          if ! git show-ref --verify --quiet refs/remotes/origin/${{ env.WEB_BRANCH }}; then
            echo "Web branch does not exist, creating it from main"
            git checkout -b ${{ env.WEB_BRANCH }}
            git push origin ${{ env.WEB_BRANCH }}
          else
            echo "Web branch exists, checking it out"
            git checkout ${{ env.WEB_BRANCH }}
          fi

      - name: Clean web branch
        run: |
          # å¤‡ä»½é‡è¦æ–‡ä»¶
          if [ -f CNAME ]; then
            cp CNAME /tmp/CNAME.backup
          fi
          if [ -f .nojekyll ]; then
            cp .nojekyll /tmp/.nojekyll.backup
          fi
          
          # æ¸…ç©ºç›®å½•ä½†ä¿ç•™.gitå’Œé‡è¦æ–‡ä»¶
          find . -maxdepth 1 -not -name '.git' -not -name '.' -not -name 'CNAME' -not -name '.nojekyll' -exec rm -rf {} \;
          
          # æ¢å¤é‡è¦æ–‡ä»¶
          if [ -f /tmp/CNAME.backup ]; then
            mv /tmp/CNAME.backup CNAME
          fi
          if [ -f /tmp/.nojekyll.backup ]; then
            mv /tmp/.nojekyll.backup .nojekyll
          fi

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist-files
          path: ./dist/

      - name: Copy build files
        run: |
          cp -r dist/* .
          
          # æ·»åŠ æ„å»ºä¿¡æ¯åˆ°HTML
          if [ -f index.html ]; then
            sed -i "s|</head>|  <!-- Build Info: v${{ steps.build_info.outputs.build_number }} - ${{ steps.build_info.outputs.build_time }} - ${{ steps.build_info.outputs.build_hash }} -->\n</head>|" index.html
          fi

      - name: Commit and push to web branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Deploy: v${{ steps.build_info.outputs.build_number }} (${{ steps.build_info.outputs.build_time }})
            
            ğŸ“¦ Build Info:
            - Version: v${{ steps.build_info.outputs.build_number }}
            - Hash: ${{ steps.build_info.outputs.build_hash }}
            - Time: ${{ steps.build_info.outputs.build_time }}
            - Trigger: ${{ github.event_name }}
            - Actor: ${{ github.actor }}"
            
            git push origin ${{ env.WEB_BRANCH }}
          fi

  # åˆ›å»ºå‘å¸ƒ
  create-release:
    name: ğŸ“¦ åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for release
        run: npm run build

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–æœ€è¿‘çš„æäº¤ä¿¡æ¯ï¼Œä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼
          if git rev-parse --verify ${{ github.sha }} >/dev/null 2>&1; then
            # å¦‚æœå½“å‰æäº¤å­˜åœ¨ï¼Œè·å–æœ€è¿‘çš„æäº¤
            COMMITS=$(git log --oneline -10 --pretty=format:"- %s (%h)" HEAD~10..HEAD 2>/dev/null || git log --oneline -10 --pretty=format:"- %s (%h)" 2>/dev/null)
          else
            # å¦‚æœæäº¤ä¸å­˜åœ¨ï¼Œä½¿ç”¨HEAD
            COMMITS=$(git log --oneline -10 --pretty=format:"- %s (%h)" 2>/dev/null || echo "- æ— æ³•è·å–æäº¤å†å²")
          fi
          
          # å¦‚æœæ²¡æœ‰è·å–åˆ°æäº¤ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯
          if [ -z "$COMMITS" ]; then
            COMMITS="- æ„å»ºç‰ˆæœ¬: v${{ github.run_number }}"
            COMMITS="$COMMITS"$'\n'"- æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            COMMITS="$COMMITS"$'\n'"- æäº¤å“ˆå¸Œ: ${{ github.sha }}"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          name: WebHome v${{ github.run_number }}
          body: |
            ## ğŸ  WebHome - ä¸ªäººä¸»é¡µ
            
            **ğŸš€ å‘å¸ƒä¿¡æ¯**
            - **ç‰ˆæœ¬**: v${{ github.run_number }}
            - **å‘å¸ƒæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
            - **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            - **è§¦å‘è€…**: ${{ github.actor }}
            - **å·¥ä½œæµ**: ${{ github.workflow }}
            
            **ğŸ“ æ›´æ–°å†…å®¹**
            ${{ steps.changelog.outputs.changelog }}
            
            **ğŸ“¦ å‘å¸ƒå†…å®¹**
            - âœ… å®Œæ•´çš„é™æ€ç½‘ç«™æ–‡ä»¶
            - âœ… ä¼˜åŒ–çš„ Vue.js 3 åº”ç”¨
            - âœ… TypeScript æ”¯æŒ
            - âœ… å“åº”å¼è®¾è®¡
            - âœ… ç§»åŠ¨ç«¯é€‚é…
            - âœ… PWA æ”¯æŒ
            
            **ğŸ¯ åŠŸèƒ½ç‰¹æ€§**
            - **ğŸ¨ å¤´éƒ¨å¯¼èˆª**: å¯é…ç½®çš„ Logo å’Œå“ç‰Œæ ‡è¯†
            - **ğŸ“ é¦–é¡µä»‹ç»**: è‡ªå®šä¹‰æ ‡é¢˜å’Œå‰¯æ ‡é¢˜
            - **ğŸ”— é“¾æ¥æ¨¡å—**: å¡ç‰‡å¼å¸ƒå±€ï¼Œæ”¯æŒåˆ†é¡µå’Œæ‹–æ‹½
            - **ğŸ“± ç¤¾äº¤é“¾æ¥**: é¡µè„šç¤¾äº¤é“¾æ¥å±•ç¤º
            - **ğŸ¨ å›¾æ ‡ç³»ç»Ÿ**: åŸºäº @vicons/fa çš„å›¾æ ‡åº“
            - **ğŸŒ™ ä¸»é¢˜æ”¯æŒ**: æ˜æš—ä¸»é¢˜åˆ‡æ¢
            
            **ğŸ”§ æŠ€æœ¯æ ˆ**
            - Vue 3 + TypeScript
            - Vite æ„å»ºå·¥å…·
            - å“åº”å¼ CSS Grid å¸ƒå±€
            - è§¦æ§å’Œé¼ æ ‡äº¤äº’æ”¯æŒ
            - GitHub Actions è‡ªåŠ¨åŒ–éƒ¨ç½²
            
            **ğŸ“± è®¾å¤‡æ”¯æŒ**
            - ğŸ“± æ‰‹æœºç«¯ (â‰¤480px): 1åˆ—å¸ƒå±€
            - ğŸ“± å¹³æ¿ç«¯ (â‰¤768px): 2åˆ—å¸ƒå±€  
            - ğŸ’» ç¬”è®°æœ¬ (â‰¤1024px): 3åˆ—å¸ƒå±€
            - ğŸ–¥ï¸ æ¡Œé¢ç«¯ (â‰¤1440px): 4åˆ—å¸ƒå±€
            - ğŸ–¥ï¸ å¤§å± (>1440px): 5åˆ—å¸ƒå±€
            
            **ğŸ”— ç›¸å…³é“¾æ¥**
            - [ğŸ“– ä½¿ç”¨æ–‡æ¡£](https://github.com/GWen124/WEBHome)
            - [ğŸ› é—®é¢˜åé¦ˆ](https://github.com/GWen124/WEBHome/issues)
            - [ğŸ’¡ åŠŸèƒ½å»ºè®®](https://github.com/GWen124/WEBHome/discussions)
            
          draft: false
          prerelease: false

      - name: Create Release Archive
        run: |
          cd ${{ env.BUILD_DIR }}
          zip -r ../webhome-v${{ github.run_number }}.zip .
          cd ..
          echo "Archive created: webhome-v${{ github.run_number }}.zip"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: ./webhome-v${{ github.run_number }}.zip
          tag_name: v${{ github.run_number }}
          prerelease: false

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥
  notify:
    name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [build-and-deploy, create-release]
    if: always()
    
    steps:
      - name: Deployment Status
        run: |
          if [ "${{ needs.build-and-deploy.result }}" == "success" ] && [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ ç½‘ç«™åœ°å€: https://your-domain.com"
            echo "ğŸ“¦ å‘å¸ƒç‰ˆæœ¬: v${{ github.run_number }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
            echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi


