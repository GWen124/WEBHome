name: Deploy to Web Branch

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: app/package.json

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Build project
        working-directory: app
        run: npm run build

      - name: Checkout web branch
        uses: actions/checkout@v4
        with:
          ref: web
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean web branch (preserve CNAME)
        run: |
          # Â§á‰ªΩCNAMEÊñá‰ª∂
          if [ -f CNAME ]; then
            cp CNAME /tmp/CNAME.backup
          fi
          # Ê∏ÖÁ©∫ÁõÆÂΩï‰ΩÜ‰øùÁïô.gitÂíåCNAME
          find . -maxdepth 1 -not -name '.git' -not -name '.' -not -name 'CNAME' -exec rm -rf {} \;
          # ÊÅ¢Â§çCNAMEÊñá‰ª∂
          if [ -f /tmp/CNAME.backup ]; then
            mv /tmp/CNAME.backup CNAME
          fi

      - name: Copy build files
        run: |
          cp -r app/dist/* .
          echo "<!-- Generated on $(date) -->" > index.html.tmp
          cat index.html >> index.html.tmp
          mv index.html.tmp index.html

      - name: Commit and push to web branch
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --staged --quiet || git commit -m "Deploy: $(date '+%Y-%m-%d %H:%M:%S')"
          git push origin web

      - name: Get Current Time
        id: time
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: WebHome v${{ github.run_number }}
          body: |
            ## WebHome
            
            **ÂèëÂ∏ÉÊó∂Èó¥**: ${{ steps.time.outputs.time }}
            **ÊûÑÂª∫ÁâàÊú¨**: v${{ github.run_number }}
            **Êèê‰∫§ÂìàÂ∏å**: ${{ github.sha }}
            
            ### üì¶ ÂèëÂ∏ÉÂÜÖÂÆπ
            - ‚úÖ ÂÆåÊï¥ÁöÑÈùôÊÄÅÁΩëÁ´ôÊñá‰ª∂
            - ‚úÖ ‰ºòÂåñÁöÑ Vue.js Â∫îÁî®
            - ‚úÖ ÂìçÂ∫îÂºèËÆæËÆ°ÊîØÊåÅ
            - ‚úÖ ÁßªÂä®Á´ØÈÄÇÈÖç
            
            ### üéØ ÂäüËÉΩÁâπÊÄß
            - **Â§¥ÈÉ®ÂØºËà™**: ÂèØÈÖçÁΩÆÁöÑ Logo ÂíåÂìÅÁâåÊ†áËØÜ
            - **È¶ñÈ°µ‰ªãÁªç**: Ëá™ÂÆö‰πâÊ†áÈ¢òÂíåÂâØÊ†áÈ¢ò
            - **ÈìæÊé•Ê®°Âùó**: Âç°ÁâáÂºèÂ∏ÉÂ±ÄÔºåÊîØÊåÅÂàÜÈ°µÂíåÊãñÊãΩ
            - **È°µËÑö‰ø°ÊÅØ**: ÁâàÊùÉ‰ø°ÊÅØÂíåÁ§æ‰∫§ÈìæÊé•
            - **ÂõæÊ†áÁ≥ªÁªü**: Âü∫‰∫é @vicons/fa ÁöÑÂõæÊ†áÂ∫ì
            
            ### üîß ÊäÄÊúØÊ†à
            - Vue 3 + TypeScript
            - Vite ÊûÑÂª∫Â∑•ÂÖ∑
            - ÂìçÂ∫îÂºè CSS Grid Â∏ÉÂ±Ä
            - Ëß¶ÊéßÂíåÈº†Ê†á‰∫§‰∫íÊîØÊåÅ
            
            ### üì± ËÆæÂ§áÊîØÊåÅ
            - üì± ÊâãÊú∫Á´Ø (‚â§480px): 1ÂàóÂ∏ÉÂ±Ä
            - üì± Âπ≥ÊùøÁ´Ø (‚â§768px): 2ÂàóÂ∏ÉÂ±Ä  
            - üíª Á¨îËÆ∞Êú¨ (‚â§1024px): 3ÂàóÂ∏ÉÂ±Ä
            - üñ•Ô∏è Ê°åÈù¢Á´Ø (‚â§1440px): 4ÂàóÂ∏ÉÂ±Ä
            - üñ•Ô∏è Â§ßÂ±è (>1440px): 5ÂàóÂ∏ÉÂ±Ä
            
          draft: false
          prerelease: false

      - name: Create Release Archive
        run: |
          cd app/dist
          zip -r ../../static-website-v${{ github.run_number }}.zip .
          cd ../..

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./static-website-v${{ github.run_number }}.zip
          asset_name: static-website-v${{ github.run_number }}.zip
          asset_content_type: application/zip


